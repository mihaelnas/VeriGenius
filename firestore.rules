
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Règle pour la collection des étudiants
    match /students/{studentId} {
      // Les admins connectés peuvent tout lire, écrire, mettre à jour, supprimer
      allow read, write: if request.auth != null;
    }

    // Autorise la lecture (query) sur la collection 'students' par des services serveur
    // qui n'ont pas d'authentification utilisateur (auth == null), comme notre API route.
    // N'autorise PAS la lecture de documents individuels sans être un admin connecté.
    match /students/{studentId} {
        allow list: if true; // Permet aux requêtes `where` de fonctionner depuis le serveur
    }
    
    // Règle pour la collection des classes
    match /classes/{classId} {
       // Les admins connectés peuvent tout lire, écrire, mettre à jour, supprimer
      allow read, write: if request.auth != null;
    }
    
    // Règle pour la collection des logs de l'API
    match /request-logs/{logId} {
        // L'API (non authentifiée en tant qu'utilisateur) peut créer des logs
        allow create: if request.auth == null;
        // Les admins connectés peuvent lire les logs
        allow read: if request.auth != null;
        // Personne ne peut modifier ou supprimer les logs pour garantir leur intégrité
        allow update, delete: if false;
    }
  }
}
